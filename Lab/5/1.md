

```bash
terraform state list > /root/resrc-list.txt
```

Output:
```bash
aws_instance.ec2-1
aws_s3_bucket.sample_bucket
aws_security_group.allow_ssh
aws_subnet.main_subnet
aws_vpc.main_vpc
random_id.bucket_suffix
```

To fetch the instance_id
```bash
terraform state show aws_instance.ec2- | grep id
```


Remove the association of the resource ec2-instance-1 from Terraform.
```bash
terraform state rm aws_instance.ec2-1
```

Output:
```bash
root@aws-client ~/terraform-projects via üí† default on ‚òÅÔ∏è  (us-east-1) ‚ûú  terraform state list
aws_s3_bucket.sample_bucket
aws_security_group.allow_ssh
aws_subnet.main_subnet
aws_vpc.main_vpc
random_id.bucket_suffix
```

We have created another EC2 instance tagged ec2-instance-2 via the AWS CLI. However, we want to manage it using terraform now under the resource name ec2-2.

```bash
resource "aws_instance" "ec2-2" {
  ami           = "ami-06c68f701d8090592"
  instance_type = "t2.micro"

  # Replace with the actual subnet ID where you want to place ec2-instance-2
  subnet_id            = aws_subnet.main_subnet.id
  vpc_security_group_ids = [aws_security_group.allow_ssh.id]
  key_name             = "myTerraformKey"

  tags = {
    Name = "ec2-instance-2"
  }
}
```

```bash
terraform init -upgrade
terraform import aws_instance.ec2-2 <instance_id>
terrraform apply
```


We just imported a new EC2 instance into Terraform's ambit with the name ec2-2. However, it was meant as a backup instance and should be therefore named on those lines.

Using the appropriate Terraform state command, rename this instance to ec2-backup.
```bash
resource "aws_instance" "ec2-backup" {
  ami           = "ami-06c68f701d8090592"
  instance_type = "t2.micro"

  subnet_id            = aws_subnet.main_subnet.id  
  vpc_security_group_ids = [aws_security_group.allow_ssh.id]
  key_name             = "myTerraformKey"

  tags = {
    Name = "ec2-instance-2"  
  }
}
```
Then, run the mv command to rename the resource in the state:
```bash
terraform state mv aws_instance.ec2-2 aws_instance.ec2-backup
```

Verify:
```bash
root@aws-client ~/terraform-projects via üí† default on ‚òÅÔ∏è  (us-east-1) ‚ûú  terraform state list
aws_instance.ec2-backup
aws_s3_bucket.sample_bucket
aws_security_group.allow_ssh
aws_subnet.main_subnet
aws_vpc.main_vpc
random_id.bucket_suffix
```

```bash
terraform plan
terraform apply
```

What is the condition of Terraform state at present?

Note: Analyze the dynamodb table used for the state to find the answer.

## Solution
View the contents of the dynamodb table my-lock-table. Run the following command to analyze the contents of the table:
```bash
aws dynamodb scan --table-name my-lock-table

```
You should see an entry with a LockID confirming that the state has been manually locked.

Output:
```bash
root@aws-client ~/terraform-projects via üí† default on ‚òÅÔ∏è  (us-east-1) ‚ûú  aws dynamodb scan --table-name my-lock-table
{
    "Items": [
        {
            "LockID": {
                "S": "my-terraform-state-bucket-ca5dd8c1c849/terraform/state-md5"
            },
            "Digest": {
                "S": "bb816fa07a60fec8820305872fd94b4f"
            }
        },
        {
            "Operation": {
                "S": "Manual Lock"
            },
            "Version": {
                "N": "1"
            },
            "Who": {
                "S": "User"
            },
            "LockID": {
                "S": "b5e19a601bc66a6965e845733efb37ae"
            },
            "Info": {
                "S": "Manual lock for demonstration purposes"
            },
            "Created": {
                "S": "Timestamp"
            }
        }
    ],
    "Count": 2,
    "ScannedCount": 2,
    "ConsumedCapacity": null
}
```


## Q.

A manual lock on the Terraform state locks the state, preventing further operations.

The only way to resume operations is to unlock the state. However, there are two ways to do this - either delete the lock entry from the table or use the unlock command.

The following AWS CLI command unlocks the state by deleting the lock entry from the table:

```bash
aws dynamodb delete-item --table-name my-lock-table --key '{"LockID": {"S": "<lockID>"}}'
```


The following Terraform command, when executed, will unlock the state and allow to apply the Terraform lifecycle:

```bash
terraform force-unlock <lockID>
```

The <lockID> in each case should be replaced with the actual lock ID entry from the table.


